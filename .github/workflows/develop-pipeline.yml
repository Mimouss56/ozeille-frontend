name: Develop Pipeline

on:
  push:
    branches: [develop]

permissions:
  contents: write
  packages: write
  id-token: write
  actions: write

concurrency:
  group: develop-${{ github.ref }}
  cancel-in-progress: true

jobs:
  full-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Run Tests
        run: npm test -- --passWithNoTests

      - name: Build
        run: npm run build

      - name: SonarQube Full Scan
        run: |
          SONAR_TOKEN='${{ secrets.SONAR_TOKEN }}'
          if [ -z "$SONAR_TOKEN" ]; then
            echo "SONAR_TOKEN not set - skipping SonarQube full scan"
            exit 0
          fi
          echo "Run Sonar full scan (placeholder)"

  performance-tests:
    needs: full-audit
    uses: ./.github/workflows/performance-tests.yml
    with:
      path: .
      node-version: "22"
      app-url: "http://localhost:5173"
    secrets: inherit

  docker-build-push:
    needs: full-audit
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Docker Build & Push
        env:
          DOCKER_REGISTRY: ghcr.io/${{ github.repository_owner }}
        run: |
          echo "Building Docker images"
          # Placeholder: build and push images for services and frontend
          echo "docker build/push steps here (implement using npm scripts or Dockerfiles)"

  semantic-release:
    needs: [full-audit, performance-tests, docker-build-push]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      new-release-published: ${{ steps.semantic.outputs.new-release-published }}
      new-release-version: ${{ steps.semantic.outputs.new-release-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Semantic Pre-Release (develop)
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Créer une pré-release pour develop avec suffixe -dev
          npx semantic-release \
            --branches '["develop"]' \
            --tag-format 'v\${version}-dev' \
            --dry-run false || echo "No release needed"
          
          # Vérifier si un tag a été créé
          if git describe --exact-match HEAD 2>/dev/null; then
            echo "new-release-published=true" >> $GITHUB_OUTPUT
            VERSION=$(git describe --exact-match HEAD | sed 's/v//' | sed 's/-dev//')
            echo "new-release-version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "new-release-published=false" >> $GITHUB_OUTPUT
          fi

  merge-to-main:
    needs: semantic-release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: needs.semantic-release.outputs.new-release-published == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

      - name: Validate and fast-forward develop -> main
        run: |
          # Fetch branches
          git fetch origin main develop --no-tags
          
          # Vérifier que main n'a pas divergé de develop
          if ! git merge-base --is-ancestor origin/main origin/develop; then
            echo "::error::main has commits that develop doesn't have!"
            echo "::error::Cannot fast-forward. Manual intervention required."
            exit 1
          fi
          
          # Checkout main et merge
          git checkout main
          git merge --ff-only origin/develop || {
            echo "::error::Fast-forward merge failed";
            exit 1;
          }
          
          # Push
          git push origin main
          echo "✅ Successfully fast-forwarded develop to main"
