name: Performance Tests

on:
  workflow_call:
    inputs:
      path:
        description: "Path to the project (e.g., ./frontend)"
        required: false
        type: string
        default: "./frontend"
      node-version:
        description: "Node.js version"
        required: false
        type: string
        default: "22"
      app-url:
        description: "URL of the application to test"
        required: false
        type: string
        default: "http://localhost:4173"
  workflow_dispatch:
    inputs:
      app-url:
        description: "URL of the application to test"
        required: false
        default: "http://localhost:4173"

jobs:
  lighthouse-tests:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: ${{ inputs.node-version }}

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Set Chrome Path
        run: |
          CHROME_PATH=$(which google-chrome-stable || which google-chrome || which chromium-browser || which chromium)
          echo "CHROME_PATH=$CHROME_PATH" >> $GITHUB_ENV
          echo "Chrome path: $CHROME_PATH"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ${{ inputs.path }}/node_modules
          key:
            ${{ runner.os }}-node-${{ inputs.node-version }}-${{ hashFiles(format('{0}/package-lock.json', inputs.path))
            }}
          restore-keys: |
            ${{ runner.os }}-node-${{ inputs.node-version }}-

      - name: Install dependencies
        run: npm ci

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.13.x

      - name: Build application
        run: npm run build

      - name: Start application in background
        run: |
          npm run preview &
          echo $! > .app.pid
          sleep 10
        env:
          CI: true

      - name: Wait for application to be ready
        run: |
          timeout 60 bash -c 'until curl -f ${{ inputs.app-url }}; do sleep 2; done' || exit 1

      - name: Run Lighthouse CI
        run: |
          if [ -f "lighthouserc.json" ]; then
            lhci autorun
          else
            echo "No lighthouserc.json found, creating basic config..."
            cat > lighthouserc.json << 'EOF'
          {
            "ci": {
              "collect": {
                "url": ["${{ inputs.app-url }}"],
                "numberOfRuns": 3,
                "settings": {
                  "preset": "desktop"
                }
              },
              "assert": {
                "assertions": {
                  "categories:performance": ["warn", {"minScore": 0.8}],
                  "categories:accessibility": ["error", {"minScore": 0.9}],
                  "categories:best-practices": ["warn", {"minScore": 0.8}],
                  "categories:seo": ["warn", {"minScore": 0.8}]
                }
              },
              "upload": {
                "target": "temporary-public-storage"
              }
            }
          }
          EOF
            lhci autorun
          fi

      - name: Upload Lighthouse Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: |
            ${{ inputs.path }}/.lighthouseci
          retention-days: 30

      - name: Stop application
        if: always()
        run: |
          if [ -f .app.pid ]; then
            kill $(cat .app.pid) || true
            rm .app.pid
          fi

      - name: Comment PR with Lighthouse results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            try {
              const manifestPath = path.join('${{ inputs.path }}', '.lighthouseci', 'manifest.json');
              if (fs.existsSync(manifestPath)) {
                const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
                let comment = '## ðŸ”¦ Lighthouse Performance Report\n\n';
                
                manifest.forEach((result, index) => {
                  comment += `### Run ${index + 1}\n`;
                  comment += `- **Performance**: ${Math.round(result.summary.performance * 100)}%\n`;
                  comment += `- **Accessibility**: ${Math.round(result.summary.accessibility * 100)}%\n`;
                  comment += `- **Best Practices**: ${Math.round(result.summary['best-practices'] * 100)}%\n`;
                  comment += `- **SEO**: ${Math.round(result.summary.seo * 100)}%\n\n`;
                });
                
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('Could not post Lighthouse results:', error.message);
            }
