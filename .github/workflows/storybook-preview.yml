name: Storybook Preview

on:
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, reopened, closed]
    paths:
      - "src/**"
      - ".storybook/**"
      - "package.json"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: storybook-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  storybook-check-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # ------------------------------------------------------------------
      # üõë OPTIMISATION : Si la PR est ferm√©e, on saute l'installation et l'audit
      # ------------------------------------------------------------------

      - name: Setup Node
        if: github.event.action != 'closed'
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        if: github.event.action != 'closed'
        run: npm ci

      # -----------------------------------------------------------
      # üîç PARTIE 1 : Audit (Uniquement si PR active)
      # -----------------------------------------------------------
      - name: Check for stories and deletions
        if: github.event.action != 'closed'
        id: check_stories
        run: |
          set -euo pipefail

          echo "üîç Audit Storybook : v√©rification stricte des stories"

          BASE_REF="origin/${{ github.base_ref }}"
          git fetch origin "${{ github.base_ref }}" --no-tags 2>/dev/null || true

          # R√©cup√©rer tous les fichiers modifi√©s avec leur statut
          ALL_CHANGED=$(git diff --name-status "$BASE_REF...HEAD" 2>/dev/null || true)

          echo "üìã Fichiers modifi√©s d√©tect√©s :"
          echo "$ALL_CHANGED" | head -20 || true

          declare -A COMPONENTS_OK
          declare -A COMPONENTS_MISSING
          declare -A COMPONENTS_DELETED

          while IFS=$'\t' read -r status filepath; do
            # Ne traiter que les fichiers src (composants, pages, layouts)
            if [[ ! "$filepath" =~ ^src/(components|pages|layouts)/ ]]; then
              continue
            fi
            
            # Ignorer les fichiers de test/story
            if [[ "$filepath" =~ \.(stories|test|spec)\. ]]; then
              continue
            fi
            
            # Ignorer les fichiers non TypeScript/TSX
            if [[ ! "$filepath" =~ \.(tsx?|jsx?)$ ]]; then
              continue
            fi
            
            DIR=$(dirname "$filepath")
            FILENAME=$(basename "$filepath")
            COMP_NAME="${FILENAME%.*}"
            
            # === CAS 1 : SUPPRESSION ===
            if [[ "$status" == D* ]]; then
              echo "üóëÔ∏è  Supprim√©: $COMP_NAME"
              COMPONENTS_DELETED[$COMP_NAME]=1
              continue
            fi
            
            # === CAS 2 : AJOUT/MODIFICATION ===
            if [[ "$status" == A* || "$status" == M* ]]; then
              # V√©rifier si la story existe
              if [[ -f "$DIR/$COMP_NAME.stories.tsx" || -f "$DIR/$COMP_NAME.stories.ts" ]]; then
                echo "‚úÖ Couvert: $COMP_NAME"
                COMPONENTS_OK[$COMP_NAME]=1
              else
                echo "‚ùå MANQUANT: $COMP_NAME (pas de story trouv√©e)"
                COMPONENTS_MISSING[$COMP_NAME]="$DIR/$COMP_NAME.stories.tsx"
              fi
            fi
          done <<< "$ALL_CHANGED"

          # === G√âN√âRATION DU RAPPORT ===
          COMMENT_BODY="## üìö Storybook Audit\n\n"

          # Stories manquantes - ERREUR BLOQUANTE
          if [[ ${#COMPONENTS_MISSING[@]} -gt 0 ]]; then
            echo ""
            echo "üö´ ERREUR : Les stories suivantes sont MANQUANTES :"
            COMMENT_BODY="$COMMENT_BODY**üö® STORIES MANQUANTES** (Bloquant)\n\n"
            for comp in "${!COMPONENTS_MISSING[@]}"; do
              echo "  - üìÑ $comp ‚Üí ${COMPONENTS_MISSING[$comp]}"
              COMMENT_BODY="$COMMENT_BODY- ‚ùå \`$comp\`\n"
            done
            COMMENT_BODY="$COMMENT_BODY\n"
            echo ""
          fi

          # Composants supprim√©s
          if [[ ${#COMPONENTS_DELETED[@]} -gt 0 ]]; then
            COMMENT_BODY="$COMMENT_BODY**üóëÔ∏è Composants Supprim√©s**\n\n"
            for comp in "${!COMPONENTS_DELETED[@]}"; do
              echo "Supprim√©: $comp"
              COMMENT_BODY="$COMMENT_BODY- ~\`$comp\`~\n"
            done
            COMMENT_BODY="$COMMENT_BODY\n"
          fi

          # Composants v√©rifi√©s
          if [[ ${#COMPONENTS_OK[@]} -gt 0 ]]; then
            COMMENT_BODY="$COMMENT_BODY**‚úÖ Stories Valides** (${#COMPONENTS_OK[@]} composants)\n\n"
            for comp in $(printf '%s\n' "${!COMPONENTS_OK[@]}" | sort); do
              COMMENT_BODY="$COMMENT_BODY- ‚úÖ \`$comp\`\n"
            done
            COMMENT_BODY="$COMMENT_BODY\n"
          fi

          # Aucun changement
          if [[ ${#COMPONENTS_OK[@]} -eq 0 && ${#COMPONENTS_DELETED[@]} -eq 0 && ${#COMPONENTS_MISSING[@]} -eq 0 ]]; then
            COMMENT_BODY="$COMMENT_BODY*Aucun changement d√©tect√© sur les composants*\n"
          fi

          echo "comment_body<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$COMMENT_BODY" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          # === V√âRIFICATION STRICTE : Faire √©chouer si des stories manquent ===
          if [[ ${#COMPONENTS_MISSING[@]} -gt 0 ]]; then
            echo ""
            echo "‚ùå ERREUR FATALE : ${#COMPONENTS_MISSING[@]} story(s) manquante(s)"
            exit 1
          fi

          echo ""
          echo "‚úÖ V√©rification r√©ussie"

      # -----------------------------------------------------------
      # üí¨ PARTIE 2 : Publication du Rapport (Uniquement si PR active)
      # -----------------------------------------------------------
      - name: Comment Audit Results
        if: github.event.action != 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const body = ${{ toJSON(steps.check_stories.outputs.comment_body) }};
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(c => c.body.includes('üìö Storybook Audit'));
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      # -----------------------------------------------------------
      # üöÄ PARTIE 3 : Build (Uniquement si PR active)
      # -----------------------------------------------------------
      - name: Build Storybook
        if: github.event.action != 'closed'
        run: npm run build-storybook

      # -----------------------------------------------------------
      # üßπ PARTIE 4 : Deploy OU Cleanup (G√©r√© automatiquement par l'action)
      # -----------------------------------------------------------
      - name: Deploy or Cleanup Preview
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: ./storybook-static
          preview-branch: gh-pages-pr-previews
          umbrella-dir: pr-preview
          action: auto
          # "auto" d√©tecte tout seul :
          # - Si PR Open/Sync -> D√©ploie
          # - Si PR Closed -> Supprime le dossier correspondant
